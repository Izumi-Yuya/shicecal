<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>ライフライン削除モーダル修正テスト</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .collapse-section {
            border: 2px solid #007bff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
            overflow: visible;
        }
        
        .z-index-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 300px;
            z-index: 1000;
        }
        
        .z-index-info h6 {
            margin-bottom: 10px;
            color: #28a745;
        }
        
        .z-index-info .info-item {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        /* ライフライン設備ドキュメント管理のスタイル */
        #electrical-documents-section {
            overflow: visible;
        }
        
        /* 削除確認モーダルのz-index修正 */
        #confirm-modal {
            z-index: 2050 !important;
            position: fixed !important;
        }
        
        #confirm-modal + .modal-backdrop {
            z-index: 2040 !important;
        }
        
        #confirm-modal .modal-dialog {
            z-index: 2051 !important;
        }
        
        /* 通常のモーダル */
        .modal {
            z-index: 2010 !important;
        }
        
        .modal-backdrop {
            z-index: 2000 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ライフライン削除モーダル修正テスト</h1>
        
        <div class="z-index-info">
            <h6><i class="fas fa-layer-group me-2"></i>Z-Index 情報</h6>
            <div class="info-item">
                <strong>通常モーダル:</strong> 2010
            </div>
            <div class="info-item">
                <strong>通常バックドロップ:</strong> 2000
            </div>
            <div class="info-item">
                <strong>削除確認モーダル:</strong> 2050
            </div>
            <div class="info-item">
                <strong>削除確認バックドロップ:</strong> 2040
            </div>
        </div>
        
        <div class="test-section">
            <h3>テストシナリオ</h3>
            <ol>
                <li>「ドキュメント管理を開く」ボタンをクリック</li>
                <li>折りたたみ領域が展開される</li>
                <li>「削除テスト」ボタンをクリック</li>
                <li>削除確認モーダルが<strong>最前面に</strong>表示されることを確認</li>
                <li>モーダルが操作可能であることを確認</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>電気設備ドキュメント管理</h3>
            
            <button class="btn btn-primary" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#electrical-documents-section">
                <i class="fas fa-folder-open me-2"></i>
                ドキュメント管理を開く
            </button>
            
            <div class="collapse collapse-section" id="electrical-documents-section">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>
                            電気設備ドキュメント
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>折りたたみ領域内のコンテンツです。</p>
                        <p>この領域内から削除確認モーダルを開いた時、モーダルが背面に隠れる問題を修正しました。</p>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>修正内容:</strong>
                            <ul class="mb-0 mt-2">
                                <li>削除確認モーダルを<code>&lt;body&gt;</code>直下に作成</li>
                                <li>z-indexを2050に設定（通常モーダルより高い）</li>
                                <li>バックドロップのz-indexを2040に設定</li>
                            </ul>
                        </div>
                        
                        <button class="btn btn-danger" id="test-delete-btn">
                            <i class="fas fa-trash me-2"></i>
                            削除テスト
                        </button>
                        
                        <button class="btn btn-secondary ms-2" id="test-normal-modal-btn">
                            <i class="fas fa-window-maximize me-2"></i>
                            通常モーダルテスト
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>テスト結果</h3>
            <div id="test-results" class="alert alert-secondary">
                テストを実行してください
            </div>
        </div>
    </div>
    
    <!-- 通常のモーダル（比較用） -->
    <div class="modal fade" id="normal-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">通常モーダル</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>これは通常のモーダルです（z-index: 2010）</p>
                    <p>削除確認モーダルはこれより高いz-index（2050）を持ちます。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // AppUtils.confirmDialog の簡易実装
        window.AppUtils = {
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            confirmDialog: async function(message, title = '確認', options = {}) {
                return new Promise((resolve) => {
                    // 既存のモーダルを削除
                    const existingModal = document.getElementById('confirm-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // アイコンとボタンの設定
                    let iconClass = 'fas fa-question-circle text-primary me-3 fa-2x';
                    let buttonClass = 'btn btn-primary';
                    let buttonText = 'OK';
                    
                    if (options.type === 'delete') {
                        iconClass = 'fas fa-trash text-danger me-3 fa-2x';
                        buttonClass = 'btn btn-danger';
                        buttonText = '削除';
                    }
                    
                    // モーダルHTML作成
                    const modalHtml = `
                        <div class="modal" id="confirm-modal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">${this.escapeHtml(title)}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="d-flex align-items-center">
                                            <i class="${iconClass}"></i>
                                            <div>${this.escapeHtml(message).replace(/\n/g, '<br>')}</div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirm-cancel-btn">キャンセル</button>
                                        <button type="button" class="${buttonClass}" id="confirm-ok-btn">${buttonText}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // body直下に追加
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    const modal = document.getElementById('confirm-modal');
                    const okButton = modal.querySelector('#confirm-ok-btn');
                    const cancelButton = modal.querySelector('#confirm-cancel-btn');
                    const closeButton = modal.querySelector('.btn-close');
                    
                    let isResolved = false;
                    
                    const resolveDialog = (result) => {
                        if (isResolved) return;
                        isResolved = true;
                        
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance) {
                            modal.addEventListener('hidden.bs.modal', () => {
                                modal.remove();
                                resolve(result);
                            }, { once: true });
                            modalInstance.hide();
                        } else {
                            modal.remove();
                            resolve(result);
                        }
                    };
                    
                    okButton.addEventListener('click', () => resolveDialog(true), { once: true });
                    cancelButton.addEventListener('click', () => resolveDialog(false), { once: true });
                    closeButton.addEventListener('click', () => resolveDialog(false), { once: true });
                    
                    // モーダル表示
                    const modalInstance = new bootstrap.Modal(modal, {
                        backdrop: 'static',
                        keyboard: true
                    });
                    
                    modal.addEventListener('shown.bs.modal', () => {
                        // z-indexを強制設定
                        modal.style.zIndex = '2050';
                        modal.style.position = 'fixed';
                        
                        const dialog = modal.querySelector('.modal-dialog');
                        if (dialog) {
                            dialog.style.zIndex = '2051';
                        }
                        
                        // バックドロップのz-indexも調整
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => {
                            backdrop.style.zIndex = '2040';
                        });
                        
                        console.log('Modal z-index set to:', modal.style.zIndex);
                        console.log('Backdrop z-index set to: 2040');
                        
                        okButton.focus();
                    }, { once: true });
                    
                    modalInstance.show();
                });
            }
        };
        
        // テストボタンのイベントリスナー
        document.getElementById('test-delete-btn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.className = 'alert alert-info';
            resultsDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>削除確認モーダルを表示中...';
            
            const confirmed = await AppUtils.confirmDialog(
                'このアイテムを削除しますか？\n削除したアイテムは復元できません。',
                '削除確認',
                { type: 'delete' }
            );
            
            if (confirmed) {
                resultsDiv.className = 'alert alert-success';
                resultsDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>成功:</strong> 削除が確認されました。モーダルは正しく最前面に表示されました。';
            } else {
                resultsDiv.className = 'alert alert-warning';
                resultsDiv.innerHTML = '<i class="fas fa-times-circle me-2"></i><strong>キャンセル:</strong> 削除がキャンセルされました。';
            }
        });
        
        document.getElementById('test-normal-modal-btn').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('normal-modal'));
            modal.show();
        });
        
        // 折りたたみ展開時のログ
        document.getElementById('electrical-documents-section').addEventListener('shown.bs.collapse', () => {
            console.log('Collapse section opened');
        });
    </script>
</body>
</html>
