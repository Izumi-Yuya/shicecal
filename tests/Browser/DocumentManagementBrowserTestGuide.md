# ドキュメント管理システム ブラウザテストガイド

## 概要

このドキュメントは、ドキュメント管理システムのブラウザテストの実行方法と期待される結果について説明します。

## テスト環境

### 必要な環境
- PHP 8.2+
- Laravel 9.x
- Laravel Dusk
- Chrome/Chromium ブラウザ
- ChromeDriver

### セットアップ

```bash
# Duskのインストール（未インストールの場合）
composer require --dev laravel/dusk

# Duskの初期化
php artisan dusk:install

# ChromeDriverのインストール
php artisan dusk:chrome-driver

# テスト用データベースの準備
php artisan migrate --env=testing
```

## テスト実行

### 全ブラウザテストの実行
```bash
php artisan dusk
```

### ドキュメント管理テストのみ実行
```bash
php artisan dusk tests/Browser/DocumentManagementBrowserTest.php
```

### 特定のテストメソッドの実行
```bash
php artisan dusk --filter=user_can_create_new_folder
```

### ヘッドレスモードでの実行
```bash
php artisan dusk --without-tty
```

### デバッグモード（ブラウザ表示）での実行
```bash
DUSK_HEADLESS_DISABLED=1 php artisan dusk
```

## テストケース詳細

### 1. ナビゲーション機能

#### 1.1 ドキュメントタブへのアクセス
- **目的**: ユーザーがドキュメントタブに正常にアクセスできることを確認
- **手順**:
  1. 施設詳細ページにアクセス
  2. ドキュメントタブをクリック
  3. ドキュメント管理インターフェースが表示されることを確認
- **期待結果**: ドキュメント管理画面が正常に表示される

#### 1.2 タブ状態の保持
- **目的**: ページ更新後もアクティブタブが保持されることを確認
- **手順**:
  1. ドキュメントタブをアクティブにする
  2. ページを更新
  3. ドキュメントタブがアクティブのままであることを確認
- **期待結果**: ページ更新後もドキュメントタブがアクティブ

### 2. フォルダ管理機能

#### 2.1 新規フォルダ作成
- **目的**: ユーザーが新しいフォルダを作成できることを確認
- **手順**:
  1. 「新しいフォルダ」ボタンをクリック
  2. フォルダ作成モーダルが表示されることを確認
  3. フォルダ名を入力
  4. 「作成」ボタンをクリック
  5. 新しいフォルダが表示されることを確認
- **期待結果**: 指定した名前のフォルダが作成される

#### 2.2 フォルダナビゲーション
- **目的**: フォルダ間のナビゲーションが正常に動作することを確認
- **手順**:
  1. フォルダをダブルクリック
  2. フォルダ内に移動することを確認
  3. パンくずナビゲーションが表示されることを確認
- **期待結果**: フォルダ内に移動し、パンくずナビゲーションが更新される

#### 2.3 パンくずナビゲーション
- **目的**: パンくずナビゲーションによる移動が正常に動作することを確認
- **手順**:
  1. ネストしたフォルダ構造を作成
  2. 子フォルダに移動
  3. パンくずの親フォルダをクリック
  4. 親フォルダに戻ることを確認
- **期待結果**: パンくずクリックで正しいフォルダに移動する

#### 2.4 フォルダ名変更
- **目的**: フォルダの名前変更機能が正常に動作することを確認
- **手順**:
  1. フォルダを右クリック
  2. コンテキストメニューから「名前を変更」を選択
  3. 新しい名前を入力
  4. 変更を保存
  5. 名前が更新されることを確認
- **期待結果**: フォルダ名が正常に変更される

#### 2.5 フォルダ削除
- **目的**: フォルダの削除機能が正常に動作することを確認
- **手順**:
  1. フォルダを右クリック
  2. コンテキストメニューから「削除」を選択
  3. 削除確認ダイアログが表示されることを確認
  4. 削除を確認
  5. フォルダが削除されることを確認
- **期待結果**: フォルダが正常に削除される

### 3. ファイル操作機能

#### 3.1 ファイルアップロード（ボタン）
- **目的**: ボタンを使用したファイルアップロードが正常に動作することを確認
- **手順**:
  1. 「ファイルアップロード」ボタンをクリック
  2. ファイル選択ダイアログが表示されることを確認
  3. PDFファイルを選択
  4. アップロードが完了することを確認
- **期待結果**: ファイルが正常にアップロードされ、リストに表示される

#### 3.2 ドラッグ&ドロップアップロード
- **目的**: ドラッグ&ドロップによるファイルアップロードが正常に動作することを確認
- **手順**:
  1. ファイルをドキュメント領域にドラッグ
  2. ドロップゾーンが強調表示されることを確認
  3. ファイルをドロップ
  4. アップロードが開始されることを確認
- **期待結果**: ドラッグ&ドロップでファイルがアップロードされる

#### 3.3 複数ファイルアップロード
- **目的**: 複数ファイルの同時アップロードが正常に動作することを確認
- **手順**:
  1. 複数のファイルを選択
  2. アップロード進行状況が表示されることを確認
  3. すべてのファイルがアップロードされることを確認
- **期待結果**: 複数ファイルが正常にアップロードされる

#### 3.4 ファイルダウンロード
- **目的**: ファイルのダウンロード機能が正常に動作することを確認
- **手順**:
  1. アップロードされたファイルをクリック
  2. ダウンロードが開始されることを確認
- **期待結果**: ファイルが正常にダウンロードされる

#### 3.5 ファイルプレビュー
- **目的**: ファイルのプレビュー機能が正常に動作することを確認
- **手順**:
  1. ファイルを右クリック
  2. コンテキストメニューから「プレビュー」を選択
  3. プレビューモーダルが表示されることを確認
- **期待結果**: ファイルのプレビューが表示される

#### 3.6 ファイル削除
- **目的**: ファイルの削除機能が正常に動作することを確認
- **手順**:
  1. ファイルを右クリック
  2. コンテキストメニューから「削除」を選択
  3. 削除確認ダイアログが表示されることを確認
  4. 削除を確認
  5. ファイルが削除されることを確認
- **期待結果**: ファイルが正常に削除される

### 4. 表示・ソート機能

#### 4.1 表示モード切り替え
- **目的**: リスト表示とアイコン表示の切り替えが正常に動作することを確認
- **手順**:
  1. リスト表示ボタンをクリック
  2. リスト形式で表示されることを確認
  3. アイコン表示ボタンをクリック
  4. アイコン形式で表示されることを確認
- **期待結果**: 表示モードが正常に切り替わる

#### 4.2 ソート機能
- **目的**: ファイル・フォルダのソート機能が正常に動作することを確認
- **手順**:
  1. 名前順（昇順）でソート
  2. 名前順（降順）でソート
  3. 日付順（新しい順）でソート
  4. 日付順（古い順）でソート
  5. フォルダが常に最初に表示されることを確認
- **期待結果**: 選択したソート順で正しく並び替えられる

#### 4.3 設定の永続化
- **目的**: 表示設定がセッション間で保持されることを確認
- **手順**:
  1. 表示モードとソート順を変更
  2. フォルダ間を移動
  3. 設定が保持されることを確認
- **期待結果**: 設定がフォルダ移動後も保持される

### 5. レスポンシブデザイン

#### 5.1 モバイル表示
- **目的**: モバイルデバイスでの表示が適切であることを確認
- **手順**:
  1. ブラウザウィンドウを375px幅に縮小
  2. レイアウトが適切に調整されることを確認
  3. タッチフレンドリーなボタンサイズを確認
- **期待結果**: モバイル表示で適切にレイアウトされる

#### 5.2 タブレット表示
- **目的**: タブレットデバイスでの表示が適切であることを確認
- **手順**:
  1. ブラウザウィンドウを768px幅に設定
  2. 中間サイズでの表示を確認
  3. アイコン表示で適切な列数が表示されることを確認
- **期待結果**: タブレット表示で適切にレイアウトされる

### 6. アクセシビリティ

#### 6.1 キーボードナビゲーション
- **目的**: キーボードのみでの操作が可能であることを確認
- **手順**:
  1. Tabキーでフォーカス移動を確認
  2. Enterキーでフォルダを開く
  3. Escapeキーでモーダルを閉じる
- **期待結果**: キーボードのみで全機能が操作可能

#### 6.2 ARIA属性とスクリーンリーダー対応
- **目的**: スクリーンリーダーでの利用が可能であることを確認
- **手順**:
  1. 開発者ツールでARIA属性を確認
  2. role、aria-label、aria-describedby属性の存在を確認
- **期待結果**: 適切なARIA属性が設定されている

### 7. エラーハンドリング

#### 7.1 ファイルアップロードエラー
- **目的**: 不正なファイルアップロード時のエラー処理が適切であることを確認
- **手順**:
  1. サポートされていないファイル形式をアップロード
  2. 適切なエラーメッセージが表示されることを確認
  3. 大きすぎるファイルをアップロード
  4. サイズ制限エラーが表示されることを確認
- **期待結果**: 適切なエラーメッセージが表示される

#### 7.2 ネットワークエラー
- **目的**: ネットワークエラー時の処理が適切であることを確認
- **手順**:
  1. ネットワークを切断
  2. ファイル操作を実行
  3. 適切なエラーメッセージが表示されることを確認
- **期待結果**: ネットワークエラーが適切に処理される

### 8. 権限制御

#### 8.1 閲覧者権限
- **目的**: 閲覧者権限での制限が適切に動作することを確認
- **手順**:
  1. 閲覧者権限のユーザーでログイン
  2. 編集ボタンが表示されないことを確認
  3. ファイルのダウンロードは可能であることを確認
- **期待結果**: 閲覧者権限で適切な制限が適用される

#### 8.2 編集者権限
- **目的**: 編集者権限でのフル機能アクセスが可能であることを確認
- **手順**:
  1. 編集者権限のユーザーでログイン
  2. すべての機能が利用可能であることを確認
- **期待結果**: 編集者権限で全機能が利用可能

## テスト実行時の注意事項

### 1. 環境設定
- テスト実行前に`.env.dusk.local`ファイルを適切に設定
- テスト用データベースが正しく設定されていることを確認
- ChromeDriverのバージョンがChromeブラウザと互換性があることを確認

### 2. ファイル準備
- テスト用のPDFファイルを`tests/fixtures/`ディレクトリに配置
- 不正なファイル形式のテストファイルも準備

### 3. ストレージ設定
- テスト実行前にストレージディレクトリの権限を確認
- `storage:link`コマンドが実行されていることを確認

### 4. 並行実行
- 複数のテストを並行実行する場合は、データベースの競合に注意
- 必要に応じて`--parallel`オプションを使用

## トラブルシューティング

### よくある問題と解決方法

#### 1. ChromeDriverの問題
```bash
# ChromeDriverを最新版に更新
php artisan dusk:chrome-driver --detect

# 特定バージョンのChromeDriverをインストール
php artisan dusk:chrome-driver 91
```

#### 2. タイムアウトエラー
```php
// テストメソッド内でタイムアウトを延長
$browser->waitFor('.element', 30); // 30秒待機
```

#### 3. 要素が見つからないエラー
```php
// 要素の存在を確認してからアクション
$browser->whenAvailable('.element', function ($browser) {
    $browser->click('.button');
});
```

#### 4. ファイルアップロードの問題
```php
// ファイルパスを絶対パスで指定
$browser->attach('input[type="file"]', __DIR__ . '/../fixtures/test.pdf');
```

## レポート生成

### スクリーンショット
テスト失敗時のスクリーンショットは`tests/Browser/screenshots/`に保存されます。

### ログ
テスト実行ログは`tests/Browser/console/`に保存されます。

### カバレッジレポート
```bash
# カバレッジレポート付きでテスト実行
php artisan dusk --coverage
```

## 継続的インテグレーション

### GitHub Actions設定例
```yaml
name: Browser Tests

on: [push, pull_request]

jobs:
  dusk-php:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Install Dependencies
        run: composer install
      - name: Run Dusk Tests
        run: php artisan dusk
```

## まとめ

このブラウザテストガイドに従って、ドキュメント管理システムの全機能が正常に動作することを確認してください。テスト結果は適切に記録し、問題が発見された場合は詳細な情報と共に報告してください。