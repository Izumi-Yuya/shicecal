# 認証・認可関連の問題管理

認証、認可、権限管理に関する問題を管理します。

## 現在の問題

### Medium 優先度

#### ISSUE-2025-09-08-003: 非アクティブユーザーのログイン制御
- **ステータス**: Open
- **発見日**: 2025-09-08
- **概要**: 非アクティブユーザーのログイン制御が実装されていない
- **詳細**: 
  - User モデルに is_active フィールドが存在
  - LoginController でのチェックが未実装
  - テストでスキップされている状態
- **セキュリティリスク**: 
  - 退職者や一時停止ユーザーがアクセス可能
  - 不正アクセスのリスク増加
- **解決案**: 
  - LoginController での is_active チェック追加
  - 適切なエラーメッセージの表示
  - テストケースの実装

## 解決済みの問題

### ISSUE-2025-09-08-R004: AnnualConfirmationController の認可不備
- **解決日**: 2025-09-08
- **問題**: 管理者以外がアクセスできてしまう脆弱性
- **解決方法**: 適切な認可チェックの追加

## 認証・認可システムの現状

### 認証機能
- **実装状況**: Laravel Sanctum を使用
- **対応機能**: 
  - ログイン・ログアウト
  - セッション管理
  - CSRF保護
- **課題**: 
  - 非アクティブユーザーのチェック未実装
  - パスワードポリシーの強化が必要

### 認可機能
- **実装状況**: ポリシーベースの認可
- **ロール**: admin, editor, primary_responder, approver, viewer
- **部署**: land_affairs, accounting, construction_planning
- **課題**: 
  - 一部コントローラーで認可チェック漏れ
  - 細かい権限制御の不足

### 権限マトリックス

| 機能 | Admin | Editor | Primary Responder | Approver | Viewer |
|------|-------|--------|-------------------|----------|--------|
| 施設閲覧 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 施設編集 | ✓ | ✓ | ✓ | ✗ | ✗ |
| 施設削除 | ✓ | ✗ | ✗ | ✗ | ✗ |
| 承認・却下 | ✓ | ✗ | ✗ | ✓ | ✗ |
| 土地情報編集 | ✓ | 部署依存 | 部署依存 | ✗ | ✗ |
| エクスポート | ✓ | ✓ | ✓ | ✓ | ✓ |
| 年次確認作成 | ✓ | ✗ | ✗ | ✗ | ✗ |
| コメント投稿 | ✓ | ✓ | ✓ | ✓ | ✓ |

## セキュリティ強化計画

### 短期的改善（1-2週間）
1. **非アクティブユーザー制御**
   - LoginController での is_active チェック
   - 適切なエラーハンドリング
   - テストケースの追加

2. **認可チェックの強化**
   - 全コントローラーでの認可チェック確認
   - ミドルウェアでの一括チェック検討

### 中期的改善（1-2ヶ月）
1. **パスワードポリシー**
   - 最小文字数の設定
   - 複雑性要件の追加
   - 定期的な変更の推奨

2. **セッション管理**
   - セッションタイムアウトの設定
   - 同時ログインセッション数の制限
   - 不正アクセス検知

### 長期的改善（3-6ヶ月）
1. **多要素認証（MFA）**
   - TOTP（Time-based One-Time Password）の導入
   - SMS認証の検討
   - バックアップコードの提供

2. **監査ログ**
   - 詳細なアクセスログ
   - 権限変更の追跡
   - 異常アクセスの検知

## セキュリティベストプラクティス

### 認証
- [ ] 強力なパスワードポリシー
- [ ] アカウントロックアウト機能
- [ ] セッション管理の適切な実装
- [ ] CSRF保護の確実な実装

### 認可
- [ ] 最小権限の原則
- [ ] ロールベースアクセス制御（RBAC）
- [ ] リソースレベルの権限制御
- [ ] 定期的な権限レビュー

### 監視・ログ
- [ ] 認証試行の記録
- [ ] 権限変更の追跡
- [ ] 異常アクセスの検知
- [ ] 定期的なセキュリティ監査

## 脆弱性対策

### 現在の対策状況
- **SQLインジェクション**: Eloquent ORM使用により対策済み
- **XSS**: Blade テンプレートのエスケープにより対策済み
- **CSRF**: Laravel標準機能により対策済み
- **セッション固定**: Laravel標準機能により対策済み

### 追加対策が必要な項目
- **ブルートフォース攻撃**: レート制限の強化
- **権限昇格**: より細かい権限制御
- **情報漏洩**: データアクセスログの強化
- **セッションハイジャック**: セッション管理の強化

## 定期的なセキュリティチェック

### 月次チェック
- [ ] 不要なユーザーアカウントの確認
- [ ] 権限設定の妥当性確認
- [ ] セキュリティログの確認
- [ ] 脆弱性スキャンの実行

### 四半期チェック
- [ ] パスワードポリシーの見直し
- [ ] アクセス権限の全体的な見直し
- [ ] セキュリティ設定の更新
- [ ] ペネトレーションテストの実施

### 年次チェック
- [ ] セキュリティポリシーの見直し
- [ ] 外部セキュリティ監査の実施
- [ ] 災害復旧計画の確認
- [ ] セキュリティ教育の実施