# モデル・データベース関連の問題管理

データモデル、データベース設計、マイグレーションに関する問題を管理します。

## 現在の問題

### High 優先度

#### ISSUE-2025-09-08-001: FacilityComment モデルの機能不足
- **ステータス**: Open
- **発見日**: 2025-09-08
- **概要**: FacilityComment モデルに status, assigned_to フィールドが不足
- **詳細**: 
  - 現在のテーブル構造: id, facility_id, user_id, section, comment, timestamps
  - 必要な機能: コメントのステータス管理、担当者割り当て
  - 影響を受ける機能: コメントワークフロー、通知システム
- **解決案**: 
  - マイグレーションでフィールド追加
  - モデルのリレーション追加
  - 既存テストの更新

### Medium 優先度

#### ISSUE-2025-09-08-004: Comment と FacilityComment の役割重複
- **ステータス**: Open
- **発見日**: 2025-09-08
- **概要**: 2つのコメントモデルが混在しており、役割が不明確
- **詳細**: 
  - `Comment` モデル: 汎用的なコメント機能
  - `FacilityComment` モデル: 施設固有のコメント機能
  - 現在は FacilityComment が主に使用されている
- **影響**: 開発効率の低下、バグの原因
- **解決案**: 
  - モデルの役割を明確化
  - 不要なモデルの削除または統合
  - 関連するコードの整理

## 解決済みの問題

### ISSUE-2025-09-08-R003: NotificationService でのモデル型不整合
- **解決日**: 2025-09-08
- **問題**: Comment と FacilityComment の型不整合
- **解決方法**: 型ヒントの統一

### ISSUE-2025-09-08-R006: CommentController でのモデル不整合
- **解決日**: 2025-09-08
- **問題**: コントローラーでのモデル参照の不整合
- **解決方法**: FacilityComment への統一

### ISSUE-2025-09-08-R007: FacilityController でのリレーション不整合
- **解決日**: 2025-09-08
- **問題**: 存在しないリレーションの参照
- **解決方法**: リレーション定義の修正

## データモデル設計の課題

### 現在のモデル構造

#### Facility モデル
- **主要フィールド**: 施設の基本情報
- **リレーション**: comments, landInfo, maintenanceHistories
- **課題**: 特になし

#### FacilityComment モデル
- **主要フィールド**: facility_id, user_id, section, comment
- **不足フィールド**: status, assigned_to, priority
- **リレーション**: facility, user (poster)
- **課題**: ワークフロー機能の不足

#### User モデル
- **主要フィールド**: 認証情報、ロール、部署
- **リレーション**: 各種作成・更新関係
- **課題**: 特になし

#### LandInfo モデル
- **主要フィールド**: 土地情報の詳細
- **リレーション**: facility
- **課題**: 特になし

### 改善計画

#### 短期的改善（1-2週間）
1. **FacilityComment モデルの拡張**
   - status フィールドの追加（pending, in_progress, resolved）
   - assigned_to フィールドの追加
   - priority フィールドの追加（optional）

2. **リレーションの整備**
   - assignee リレーションの追加
   - 適切なインデックスの設定

#### 中期的改善（1-2ヶ月）
1. **Comment モデルの整理**
   - 使用状況の調査
   - 統合または削除の検討
   - マイグレーション計画の策定

2. **データ整合性の向上**
   - 外部キー制約の追加
   - バリデーションルールの強化
   - データクリーニング

#### 長期的改善（3-6ヶ月）
1. **パフォーマンス最適化**
   - インデックス戦略の見直し
   - クエリ最適化
   - キャッシュ戦略の導入

2. **スケーラビリティ対応**
   - パーティショニング検討
   - 読み取り専用レプリカの導入
   - アーカイブ戦略の策定

## データベース設計ベストプラクティス

### マイグレーション管理
- [ ] 本番環境での実行前にステージング環境でテスト
- [ ] ロールバック計画の策定
- [ ] データ移行スクリプトの作成
- [ ] パフォーマンスへの影響評価

### モデル設計
- [ ] 適切なリレーションの定義
- [ ] バリデーションルールの設定
- [ ] アクセサ・ミューテータの活用
- [ ] スコープの適切な使用

### データ整合性
- [ ] 外部キー制約の設定
- [ ] 一意制約の適切な使用
- [ ] NULL制約の検討
- [ ] デフォルト値の設定

## 監視・メンテナンス

### 定期的なチェック項目
- データベースサイズの監視
- スロークエリの特定と最適化
- インデックス使用状況の確認
- データ整合性チェック

### アラート設定
- データベース接続エラー
- スロークエリの発生
- ディスク使用量の増加
- レプリケーション遅延