# 実装計画

- [x] 1. データベース設計とマイグレーション作成
  - document_folders テーブルのマイグレーション作成
  - document_files テーブルのマイグレーション作成
  - 既存のfiles テーブルとの整合性確認
  - インデックス設定の最適化
  - _要件: 1.3, 2.1, 3.1_

- [x] 2. モデルクラスの実装
  - [x] 2.1 DocumentFolder モデルの作成
    - 基本的なEloquent モデル設定
    - リレーションシップの定義（facility, parent, children, files, creator）
    - パス生成メソッドの実装
    - 削除可能性チェックメソッドの実装
    - _要件: 2.1, 3.1, 3.2_

  - [x] 2.2 DocumentFile モデルの作成
    - 基本的なEloquent モデル設定
    - リレーションシップの定義（facility, folder, uploader）
    - ファイルサイズフォーマット機能
    - ファイルアイコン・色取得機能
    - ダウンロードURL生成機能
    - _要件: 7.1, 8.1, 6.6_

- [x] 3. ファイル処理サービスの拡張
  - [x] 3.1 FileHandlingService の拡張
    - ドキュメント用ファイルタイプ設定追加
    - S3/ローカルストレージの環境別対応
    - バッチファイル操作機能の追加
    - _要件: 7.2, 7.3, 8.6_

  - [x] 3.2 DocumentService の作成
    - フォルダ作成・更新・削除機能
    - ファイルアップロード・削除・移動機能
    - フォルダ内容取得機能（ソート・フィルタ対応）
    - パンくずナビゲーション生成機能
    - ストレージ統計情報取得機能
    - _要件: 2.1, 2.2, 3.1, 5.1, 5.2_

- [x] 4. 認可システムの実装
  - [x] 4.1 DocumentPolicy の作成
    - 施設ドキュメント表示権限チェック
    - フォルダ・ファイル作成権限チェック
    - フォルダ・ファイル編集・削除権限チェック
    - 既存のUser権限システムとの統合
    - _要件: 9.1, 9.2, 9.3, 9.4_

- [x] 5. バリデーション機能の実装
  - [x] 5.1 リクエストバリデーションクラスの作成
    - CreateFolderRequest（フォルダ作成用）
    - RenameFolderRequest（フォルダ名変更用）
    - UploadFileRequest（ファイルアップロード用）
    - フォルダ名重複チェック機能
    - ファイル形式・サイズ検証機能
    - _要件: 2.3, 7.2, 7.3, 6.4_

- [x] 6. コントローラーの実装
  - [x] 6.1 DocumentController の作成
    - ドキュメントタブ表示機能（index）
    - フォルダ内容表示機能（show）
    - 適切なエラーハンドリング
    - JSON/HTML レスポンス対応
    - _要件: 1.1, 1.2, 4.1, 4.2_

  - [x] 6.2 フォルダ操作エンドポイントの実装
    - フォルダ作成API（createFolder）
    - フォルダ名変更API（renameFolder）
    - フォルダ削除API（deleteFolder）
    - 認可チェックとエラーハンドリング
    - _要件: 2.1, 2.2, 2.5, 2.6_

  - [x] 6.3 ファイル操作エンドポイントの実装
    - ファイルアップロードAPI（uploadFile）
    - ファイルダウンロード機能（downloadFile）
    - ファイルプレビュー機能（previewFile）
    - ファイル削除API（deleteFile）
    - _要件: 7.1, 7.4, 8.1, 8.2, 8.3_

- [x] 7. フロントエンド基盤の実装
  - [x] 7.1 ドキュメントタブのUI実装
    - 施設詳細画面へのタブ追加
    - タブアクティブ状態管理
    - 既存タブとの統合
    - レスポンシブデザイン対応
    - _要件: 1.1, 1.2, 10.1, 10.2_

  - [x] 7.2 フォルダ・ファイル表示コンポーネント
    - リスト表示モードの実装
    - アイコン表示モードの実装
    - 表示モード切り替え機能
    - ファイル・フォルダアイコン表示
    - _要件: 4.1, 4.2, 4.3, 6.1, 6.2_

  - [x] 7.3 ナビゲーション機能の実装
    - パンくずナビゲーション表示
    - フォルダダブルクリック移動
    - パンくずクリック移動
    - フォルダ階層の視覚的表示
    - _要件: 3.2, 3.3, 3.6_

- [x] 8. ソート・フィルタ機能の実装
  - [x] 8.1 ソート機能の実装
    - 名前ソート（昇順・降順）
    - 日付ソート（昇順・降順）
    - フォルダ優先表示
    - ソート状態の保持
    - _要件: 5.1, 5.2, 5.3, 5.6_

  - [x] 8.2 表示設定の永続化
    - セッションでの設定保持
    - フォルダ移動時の設定維持
    - ユーザー設定の記憶
    - _要件: 4.4, 5.6_

- [x] 9. ファイル操作機能の実装
  - [x] 9.1 ファイルアップロード機能
    - ドラッグ&ドロップアップロード
    - 複数ファイル同時アップロード
    - アップロード進行状況表示
    - エラーハンドリングとメッセージ表示
    - _要件: 7.1, 7.4, 7.5, 7.6_

  - [x] 9.2 ファイル管理機能
    - ファイル名表示（省略・ツールチップ対応）
    - ファイルサイズ表示
    - ファイル削除機能
    - 右クリックコンテキストメニュー
    - _要件: 6.1, 6.2, 6.3, 6.6_

- [x] 10. フォルダ管理機能の実装
  - [x] 10.1 フォルダ作成・編集機能
    - 新規フォルダ作成モーダル
    - フォルダ名変更機能
    - フォルダ削除確認ダイアログ
    - ネストフォルダ作成対応
    - _要件: 2.1, 2.2, 2.3, 2.6, 3.4_

  - [x] 10.2 フォルダ操作UI
    - 右クリックコンテキストメニュー
    - フォルダアイコンと状態表示
    - 空フォルダ・ファイル数表示
    - _要件: 2.5, 3.6_

- [x] 11. JavaScript モジュールの実装
  - [x] 11.1 DocumentManager クラスの作成
    - フォルダナビゲーション管理
    - ファイル操作イベント処理
    - API通信とエラーハンドリング
    - UI状態管理
    - _要件: 1.3, 3.1, 3.2, 3.3_

  - [x] 11.2 ファイルアップロード処理
    - FormData を使用したファイル送信
    - 進行状況表示とキャンセル機能
    - 複数ファイル処理
    - エラー状態の表示
    - _要件: 7.1, 7.4, 7.5, 7.6_

- [x] 12. CSS スタイリングの実装
  - [x] 12.1 ドキュメント管理UI のスタイル
    - 既存の施設管理UIとの統一
    - レスポンシブデザイン対応
    - アクセシビリティ対応
    - アニメーション効果
    - _要件: 10.4, 10.5_

  - [x] 12.2 ファイル・フォルダ表示スタイル
    - リスト表示とアイコン表示のスタイル
    - ファイルタイプ別アイコン
    - ホバー効果とアクティブ状態
    - ドラッグ&ドロップ視覚効果
    - _要件: 4.2, 4.3, 6.1, 6.2_

- [x] 13. エラーハンドリングとログ機能
  - [x] 13.1 包括的エラーハンドリング
    - バリデーションエラーの適切な表示
    - システムエラーの安全な処理
    - ネットワークエラーの対応
    - ユーザーフレンドリーなエラーメッセージ
    - _要件: 7.5, 8.5, 10.5_

  - [x] 13.2 アクティビティログ統合
    - ドキュメント操作のログ記録
    - 既存のActivityLogService との統合
    - セキュリティ監査ログ
    - _要件: 9.4_

- [-] 14. セキュリティ機能の実装
  - [x] 14.1 ファイルアクセス制御
    - 認証チェック機能
    - ファイルダウンロード時の権限確認
    - パストラバーサル攻撃対策
    - CSRF保護
    - _要件: 8.4, 9.1, 9.2, 9.3_

  - [x] 14.2 ファイル検証機能
    - MIMEタイプ検証
    - ファイル拡張子チェック
    - ファイルサイズ制限
    - 悪意のあるファイル検出
    - _要件: 7.2, 7.3_

- [-] 15. テスト実装
  - [x] 15.1 単体テストの作成
    - DocumentFolder モデルテスト
    - DocumentFile モデルテスト
    - DocumentService テスト
    - DocumentPolicy テスト
    - _要件: 全要件のテストカバレッジ_

  - [x] 15.2 機能テストの作成
    - ドキュメント管理API テスト
    - ファイルアップロード・ダウンロードテスト
    - 権限制御テスト
    - エラーハンドリングテスト
    - _要件: 全要件の統合テスト_

  - [x] 15.3 ブラウザテストの作成
    - フォルダ作成・削除操作テスト
    - ファイルアップロード UI テスト
    - ナビゲーション機能テスト
    - レスポンシブデザインテスト
    - _要件: UI/UX要件のテスト_

- [x] 16. パフォーマンス最適化
  - [x] 16.1 データベース最適化
    - インデックス設定の確認
    - N+1問題の解決
    - クエリ最適化
    - ページネーション実装
    - _要件: 大量データ処理対応_

  - [x] 16.2 フロントエンド最適化
    - 遅延読み込み実装
    - 仮想スクロール（大量ファイル対応）
    - キャッシュ戦略実装
    - バンドルサイズ最適化
    - _要件: パフォーマンス要件_

- [x] 17. 統合とデプロイメント準備
  - [x] 17.1 既存システムとの統合テスト
    - 施設詳細画面での動作確認
    - 既存権限システムとの連携確認
    - アクティビティログ統合確認
    - タブ切り替え動作確認
    - _要件: 10.1, 10.2, 10.3, 10.6_

  - [x] 17.2 環境別設定とデプロイメント
    - テスト環境（SQLite + ローカルストレージ）設定
    - 開発・本番環境（MySQL + S3）設定
    - 環境変数設定
    - マイグレーション実行手順
    - _要件: 環境別ストレージ対応_

- [x] 18. ドキュメントと運用準備
  - [x] 18.1 ユーザーマニュアル作成
    - ドキュメント管理機能の使用方法
    - フォルダ・ファイル操作手順
    - トラブルシューティングガイド
    - _要件: ユーザビリティ向上_

  - [x] 18.2 運用・保守ドキュメント
    - システム管理者向けガイド
    - バックアップ・復旧手順
    - パフォーマンス監視設定
    - セキュリティ設定確認項目
    - _要件: 運用保守性_