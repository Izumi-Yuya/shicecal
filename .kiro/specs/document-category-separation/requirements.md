# ドキュメント管理システムのカテゴリ分離 - 要件定義

## イントロダクション

現在、ライフライン設備のドキュメント管理とメインのドキュメント管理が同じデータベーステーブルを共有しているため、ライフライン設備で作成したフォルダやファイルがメインのドキュメントタブに表示されてしまう問題があります。

この問題を解決するため、`category`カラムを追加してデータを明確に分離し、各システムが独立して動作するようにします。

## 要件

### 要件1: データベーススキーマの拡張

**ユーザーストーリー**: システム管理者として、ドキュメントのカテゴリを明確に識別できるようにしたい。そうすることで、異なるシステムのドキュメントが混在しないようにできる。

#### 受入基準

1. WHEN データベースマイグレーションを実行する THEN `document_folders`テーブルに`category`カラムが追加される
2. WHEN データベースマイグレーションを実行する THEN `document_files`テーブルに`category`カラムが追加される
3. WHEN `category`カラムが追加される THEN `VARCHAR(50)`型で`nullable`である
4. WHEN `category`カラムが追加される THEN `facility_id`の後に配置される
5. WHEN インデックスが作成される THEN `(facility_id, category)`の複合インデックスが両テーブルに存在する
6. WHEN 既存データが存在する THEN `category`カラムは`NULL`のまま（メインドキュメントとして扱う）

### 要件2: モデルの拡張

**ユーザーストーリー**: 開発者として、カテゴリ別にドキュメントをフィルタリングできるようにしたい。そうすることで、各システムが独自のドキュメントのみを扱えるようにできる。

#### 受入基準

1. WHEN `DocumentFolder`モデルを使用する THEN `category`フィールドが`fillable`に含まれる
2. WHEN `DocumentFile`モデルを使用する THEN `category`フィールドが`fillable`に含まれる
3. WHEN メインドキュメントをクエリする THEN `scopeMain()`メソッドで`category IS NULL`のレコードのみ取得できる
4. WHEN ライフライン設備ドキュメントをクエリする THEN `scopeLifeline($category)`メソッドで`category = 'lifeline_{$category}'`のレコードのみ取得できる
5. WHEN 修繕履歴ドキュメントをクエリする THEN `scopeMaintenance($category)`メソッドで`category = 'maintenance_{$category}'`のレコードのみ取得できる
6. WHEN カテゴリを判定する THEN `isMain()`, `isLifeline()`, `isMaintenance()`メソッドが正しく動作する

### 要件3: DocumentServiceの更新

**ユーザーストーリー**: 開発者として、メインドキュメント管理サービスがメインドキュメントのみを扱うようにしたい。そうすることで、他のシステムのドキュメントが混入しないようにできる。

#### 受入基準

1. WHEN `DocumentService::createFolder()`を実行する THEN 作成されるフォルダの`category`は`NULL`である
2. WHEN `DocumentService::uploadFile()`を実行する THEN 作成されるファイルの`category`は`NULL`である
3. WHEN `DocumentService::getFolderContents()`を実行する THEN `category IS NULL`のフォルダとファイルのみ取得される
4. WHEN `DocumentService::getAvailableFileTypes()`を実行する THEN `category IS NULL`のファイルのみ集計される
5. WHEN `DocumentService::getFolderStats()`を実行する THEN `category IS NULL`のデータのみカウントされる

### 要件4: LifelineDocumentServiceの更新

**ユーザーストーリー**: 開発者として、ライフライン設備ドキュメント管理サービスがライフライン設備のドキュメントのみを扱うようにしたい。そうすることで、メインドキュメントと混在しないようにできる。

#### 受入基準

1. WHEN `LifelineDocumentService::getOrCreateCategoryRootFolder()`を実行する THEN 作成されるフォルダの`category`は`'lifeline_{$category}'`である
2. WHEN ライフライン設備のフォルダを作成する THEN `category`は親フォルダから継承される
3. WHEN ライフライン設備のファイルをアップロードする THEN `category`は所属フォルダから継承される
4. WHEN `LifelineDocumentService::getCategoryDocuments()`を実行する THEN 指定されたカテゴリのドキュメントのみ取得される
5. WHEN `LifelineDocumentService::getCategoryStats()`を実行する THEN 指定されたカテゴリのデータのみ集計される

### 要件5: MaintenanceDocumentServiceの更新

**ユーザーストーリー**: 開発者として、修繕履歴ドキュメント管理サービスが修繕履歴のドキュメントのみを扱うようにしたい。そうすることで、他のシステムのドキュメントと混在しないようにできる。

#### 受入基準

1. WHEN 修繕履歴のフォルダを作成する THEN `category`は`'maintenance_{$category}'`である
2. WHEN 修繕履歴のフォルダを作成する THEN `category`は親フォルダから継承される
3. WHEN 修繕履歴のファイルをアップロードする THEN `category`は所属フォルダから継承される
4. WHEN 修繕履歴のドキュメントを取得する THEN 指定されたカテゴリのドキュメントのみ取得される
5. WHEN 修繕履歴の統計を取得する THEN 指定されたカテゴリのデータのみ集計される

### 要件6: 既存データの互換性

**ユーザーストーリー**: システム管理者として、既存のドキュメントが引き続き正常に動作するようにしたい。そうすることで、データ移行時の問題を回避できる。

#### 受入基準

1. WHEN マイグレーションを実行する THEN 既存のフォルダとファイルの`category`は`NULL`のまま
2. WHEN 既存のメインドキュメントにアクセスする THEN 正常に表示される
3. WHEN 既存のライフライン設備フォルダが存在する THEN 自動的に適切な`category`が設定される（オプション）
4. WHEN 既存の修繕履歴フォルダが存在する THEN 自動的に適切な`category`が設定される（オプション）

### 要件7: UI/UXの独立性

**ユーザーストーリー**: ユーザーとして、メインドキュメントタブでメインドキュメントのみを見たい。そうすることで、ライフライン設備や修繕履歴のドキュメントと混同しないようにできる。

#### 受入基準

1. WHEN メインドキュメントタブを開く THEN ライフライン設備のフォルダは表示されない
2. WHEN メインドキュメントタブを開く THEN 修繕履歴のフォルダは表示されない
3. WHEN ライフライン設備のドキュメントセクションを開く THEN メインドキュメントのフォルダは表示されない
4. WHEN 修繕履歴のドキュメントセクションを開く THEN メインドキュメントのフォルダは表示されない
5. WHEN 各システムでフォルダを作成する THEN 他のシステムには表示されない

### 要件8: パフォーマンスの最適化

**ユーザーストーリー**: 開発者として、カテゴリ別のクエリが効率的に実行されるようにしたい。そうすることで、大量のドキュメントがある場合でもパフォーマンスを維持できる。

#### 受入基準

1. WHEN カテゴリ別にドキュメントをクエリする THEN 複合インデックス`(facility_id, category)`が使用される
2. WHEN メインドキュメントをクエリする THEN `category IS NULL`の条件でインデックスが効率的に使用される
3. WHEN 大量のドキュメントが存在する THEN クエリ実行時間が1秒以内である
4. WHEN カテゴリ別の統計を取得する THEN 集計クエリが効率的に実行される

### 要件9: テストカバレッジ

**ユーザーストーリー**: 開発者として、カテゴリ分離が正しく動作することを確認したい。そうすることで、リグレッションを防ぐことができる。

#### 受入基準

1. WHEN メインドキュメントのテストを実行する THEN 他のカテゴリのドキュメントが混入しないことが確認される
2. WHEN ライフライン設備のテストを実行する THEN 正しいカテゴリのドキュメントのみ取得されることが確認される
3. WHEN 修繕履歴のテストを実行する THEN 正しいカテゴリのドキュメントのみ取得されることが確認される
4. WHEN カテゴリ間の独立性テストを実行する THEN 各システムが互いに干渉しないことが確認される

### 要件10: ドキュメントとログ

**ユーザーストーリー**: 開発者として、カテゴリ分離の実装方法を理解したい。そうすることで、将来的なメンテナンスが容易になる。

#### 受入基準

1. WHEN 実装ガイドを参照する THEN カテゴリ値の命名規則が明確に記載されている
2. WHEN 実装ガイドを参照する THEN 各サービスでのカテゴリ設定方法が説明されている
3. WHEN トラブルシューティングガイドを参照する THEN よくある問題と解決方法が記載されている
4. WHEN マイグレーションログを確認する THEN カテゴリカラムの追加が記録されている

## カテゴリ値の定義

### メインドキュメント
- 値: `NULL`
- 説明: 施設全体の汎用ドキュメント

### ライフライン設備
- 値: `lifeline_electrical`, `lifeline_gas`, `lifeline_water`, `lifeline_elevator`, `lifeline_hvac_lighting`
- 説明: 各設備カテゴリのドキュメント

### 修繕履歴
- 値: `maintenance_exterior`, `maintenance_interior`, `maintenance_summer_condensation`, `maintenance_other`
- 説明: 各修繕カテゴリのドキュメント

## 成功基準

1. ✅ ライフライン設備でフォルダを作成しても、メインドキュメントタブに表示されない
2. ✅ メインドキュメントでフォルダを作成しても、ライフライン設備に表示されない
3. ✅ 修繕履歴でフォルダを作成しても、他のシステムに表示されない
4. ✅ 既存のドキュメントが引き続き正常に動作する
5. ✅ パフォーマンスが維持される（クエリ実行時間 < 1秒）
6. ✅ すべてのテストがパスする

## 制約事項

1. 既存のドキュメントデータを保持する必要がある
2. ダウンタイムを最小限にする必要がある
3. 後方互換性を維持する必要がある
4. パフォーマンスを低下させてはいけない

## 除外事項

1. 完全なテーブル分離（将来的な検討事項）
2. カテゴリ間でのドキュメント移動機能（将来的な検討事項）
3. カテゴリ固有のカスタムフィールド（将来的な検討事項）
