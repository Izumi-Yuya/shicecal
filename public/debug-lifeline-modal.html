<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ライフラインモーダルデバッグ</title>
    <meta name="csrf-token" content="debug-token">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>ライフラインモーダルデバッグ</h1>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5>デバッグ情報</h5>
                <div id="debug-output" class="mt-3">
                    <pre id="debug-log" style="background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5>テストボタン</h5>
                <button id="test-modal-btn" class="btn btn-primary">モーダルを開く（electric）</button>
                <button id="check-dom-btn" class="btn btn-secondary">DOM構造を確認</button>
                <button id="check-api-btn" class="btn btn-info">API呼び出しテスト</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        const debugLog = document.getElementById('debug-log');
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            debugLog.textContent += logMessage + '\n\n';
            console.log(message, data);
        }

        // LifelineDocumentManagerをインポート
        import LifelineDocumentManager from '/build/assets/app-unified-bf359c99.e03ef302.js';
        
        log('LifelineDocumentManager loaded', { available: !!LifelineDocumentManager });

        // テストボタン
        document.getElementById('test-modal-btn').addEventListener('click', () => {
            log('Opening modal for electric category...');
            try {
                const facilityId = 1; // テスト用
                const manager = LifelineDocumentManager.openInModal(facilityId, 'electric', {
                    modalIdPrefix: 'electrical-documents-modal'
                });
                log('Manager created', {
                    facilityId: manager.facilityId,
                    category: manager.category,
                    apiCategory: manager.apiCategory
                });
            } catch (error) {
                log('ERROR opening modal', { error: error.message, stack: error.stack });
            }
        });

        // DOM構造確認
        document.getElementById('check-dom-btn').addEventListener('click', () => {
            log('Checking DOM structure...');
            
            const modals = document.querySelectorAll('.modal');
            log('Modals found', { count: modals.length });
            
            modals.forEach((modal, index) => {
                log(`Modal ${index + 1}`, {
                    id: modal.id,
                    classes: modal.className,
                    visible: modal.classList.contains('show')
                });
                
                const container = modal.querySelector('[data-lifeline-category]');
                if (container) {
                    log(`  Container found`, {
                        category: container.dataset.lifelineCategory
                    });
                    
                    // 各要素の存在確認
                    const elements = {
                        'loading-indicator': modal.querySelector('[id^="loading-indicator"]'),
                        'error-message': modal.querySelector('[id^="error-message"]'),
                        'empty-state': modal.querySelector('[id^="empty-state"]'),
                        'document-list': modal.querySelector('[id^="document-list"]'),
                        'document-grid': modal.querySelector('[id^="document-grid"]'),
                        'breadcrumb': modal.querySelector('[id^="document-breadcrumb"]'),
                        'pagination': modal.querySelector('[id^="document-pagination"]'),
                        'info': modal.querySelector('[id^="document-info"]')
                    };
                    
                    Object.entries(elements).forEach(([name, el]) => {
                        log(`    ${name}`, { 
                            found: !!el, 
                            id: el?.id,
                            visible: el ? !el.classList.contains('d-none') : false
                        });
                    });
                }
            });
            
            const backdrops = document.querySelectorAll('.modal-backdrop');
            log('Backdrops found', { count: backdrops.length });
        });

        // API呼び出しテスト
        document.getElementById('check-api-btn').addEventListener('click', async () => {
            log('Testing API call...');
            
            const facilityId = 1;
            const category = 'electrical'; // エイリアス変換後
            const url = `/facilities/${facilityId}/lifeline-documents/${category}?folder_id=&view_mode=list&per_page=50&page=1&sort_by=name&sort_direction=asc&filter_type=&search=&load_stats=true`;
            
            log('API URL', { url });
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log('Response status', { 
                    status: response.status, 
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                const data = await response.json();
                log('Response data', data);
                
            } catch (error) {
                log('API ERROR', { error: error.message, stack: error.stack });
            }
        });

        // グローバルエラーハンドラ
        window.addEventListener('error', (event) => {
            log('GLOBAL ERROR', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });

        log('Debug page ready');
    </script>
</body>
</html>
