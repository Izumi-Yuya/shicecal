name: CI Test - Basic Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  basic-validation:
    name: Basic Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install PHP dependencies
      run: composer install --prefer-dist --no-interaction --optimize-autoloader
      
    - name: Install Node.js dependencies
      run: npm ci
      
    - name: Create environment file
      run: |
        cp .env.example .env
        php artisan key:generate
        
    - name: Setup SQLite database
      run: |
        touch database/database.sqlite
        
    - name: Run PHP Linting (Laravel Pint)
      run: |
        echo "ğŸ¨ Running PHP code formatting check..."
        vendor/bin/pint --test
        echo "âœ… PHP code formatting passed"
      
    - name: Build Frontend Assets
      run: |
        echo "ğŸ“¦ Building frontend assets..."
        npm run build
        echo "âœ… Frontend build completed"
        
    - name: Verify Build Output
      run: |
        if [ ! -d "public/build" ]; then
          echo "âŒ Build directory not created"
          exit 1
        fi
        
        if [ ! -f "public/build/manifest.json" ]; then
          echo "âŒ Vite manifest file not generated"
          exit 1
        fi
        
        echo "âœ… Build verification passed"
        echo "ğŸ“Š Build files: $(find public/build -type f | wc -l)"
        
    - name: Basic PHP Tests
      run: |
        echo "ğŸ§ª Running basic PHP tests..."
        php artisan test --stop-on-failure --testsuite=Unit
        echo "âœ… Basic PHP tests completed"
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
        
    - name: JavaScript Linting
      run: |
        echo "ğŸ¨ Running JavaScript linting..."
        npm run lint:js || echo "âš ï¸ JavaScript linting completed with warnings"
      continue-on-error: true
      
    - name: Summary
      run: |
        echo "ğŸ¯ Basic Validation Summary"
        echo "=========================="
        echo "âœ… PHP environment setup"
        echo "âœ… Node.js environment setup"
        echo "âœ… Dependencies installed"
        echo "âœ… PHP code formatting"
        echo "âœ… Frontend build"
        echo "âœ… Basic tests"
        echo ""
        echo "ğŸš€ Basic validation completed successfully"