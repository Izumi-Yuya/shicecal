# 契約書ドキュメント統合 - 既存データ互換性確認ガイド

## 概要

このドキュメントは、契約書ドキュメント統合後の既存データ互換性を確認するための手動テストガイドです。
統合前に各サブタブに保存されていたドキュメントが、統合後も正常にアクセスできることを確認します。

## テスト環境の準備

### 前提条件
- 統合実装が完了していること
- テスト用の施設データが存在すること
- 契約書カテゴリのドキュメントが既に存在すること（理想的には統合前に作成されたもの）

### テストユーザー
- **編集者権限**: ドキュメントの作成・編集・削除が可能
- **閲覧者権限**: ドキュメントの閲覧のみ可能

## テスト項目

### 8.1 既存ドキュメントの表示確認

#### 目的
既存のフォルダとファイルが統合後も正しく表示されることを確認する。

#### テスト手順

1. **契約書タブへのアクセス**
   - 施設詳細画面を開く
   - 「契約書」タブをクリック
   - 統一ドキュメント管理セクションが表示されることを確認

2. **ドキュメントセクションの展開**
   - 「ドキュメントを表示」ボタンをクリック
   - セクションがスムーズに展開されることを確認
   - ボタンテキストが「ドキュメントを非表示」に変わることを確認
   - アイコンが変更されることを確認

3. **ルートフォルダの表示確認**
   ```
   期待される表示:
   - 契約書（ルートフォルダ）
     ├── 契約書
     ├── 見積書
     ├── 請求書
     └── その他
   ```
   - デフォルトサブフォルダが表示されることを確認
   - フォルダアイコンが正しく表示されることを確認
   - フォルダ名が正しく表示されることを確認

4. **既存フォルダの表示確認**
   - 統合前に作成されたフォルダが表示されることを確認
   - フォルダ階層が維持されていることを確認
   - 各フォルダをクリックして開けることを確認

5. **既存ファイルの表示確認**
   - 各フォルダ内のファイルが表示されることを確認
   - ファイル名が正しく表示されることを確認
   - ファイルアイコンが正しく表示されることを確認
   - ファイルサイズが表示されることを確認

#### チェックリスト

- [ ] 統一ドキュメント管理セクションが表示される
- [ ] 「ドキュメントを表示」ボタンが機能する
- [ ] セクションが展開される
- [ ] ボタンテキストとアイコンが動的に変更される
- [ ] デフォルトサブフォルダ（契約書、見積書、請求書、その他）が表示される
- [ ] 統合前に作成された既存フォルダが表示される
- [ ] フォルダ階層が正しく維持されている
- [ ] 各フォルダ内のファイルが表示される
- [ ] ファイル名が正しく表示される
- [ ] ファイルアイコンが正しく表示される
- [ ] ファイルサイズが表示される

#### 期待される結果
- すべての既存フォルダとファイルが正しく表示される
- フォルダ階層が維持されている
- 表示に遅延やエラーがない

---

### 8.2 既存ドキュメントの操作確認

#### 目的
既存のドキュメントに対する操作（ダウンロード、削除、フォルダ開閉）が正常に動作することを確認する。

#### テスト手順

##### 1. ファイルダウンロード

**手順:**
1. 既存ファイルを選択
2. ダウンロードボタンまたはファイル名をクリック
3. ファイルがダウンロードされることを確認
4. ダウンロードしたファイルを開いて内容を確認

**チェックポイント:**
- [ ] ダウンロードボタンが表示される
- [ ] クリックするとダウンロードが開始される
- [ ] ファイル名が正しい
- [ ] ファイル内容が正しい
- [ ] エラーメッセージが表示されない

**期待される動作:**
- ファイルが正常にダウンロードされる
- ダウンロードしたファイルの内容が正しい
- ブラウザのダウンロード履歴に記録される

##### 2. フォルダの開閉

**手順:**
1. フォルダをクリックして開く
2. フォルダ内のファイルとサブフォルダが表示されることを確認
3. パンくずナビゲーションが更新されることを確認
4. 「戻る」ボタンまたはパンくずリンクをクリック
5. 親フォルダに戻ることを確認

**チェックポイント:**
- [ ] フォルダをクリックすると開く
- [ ] フォルダ内のコンテンツが表示される
- [ ] パンくずナビゲーションが更新される
- [ ] 「戻る」ボタンが機能する
- [ ] パンくずリンクが機能する
- [ ] フォルダ階層の移動がスムーズ

**期待される動作:**
- フォルダの開閉が正常に動作する
- パンくずナビゲーションが正しく更新される
- フォルダ間の移動がスムーズ

##### 3. ファイル削除（編集者権限のみ）

**手順:**
1. 既存ファイルの削除ボタンをクリック
2. 確認ダイアログが表示されることを確認
3. 「削除」を選択
4. ファイルが一覧から削除されることを確認
5. ページをリロードして削除が永続化されていることを確認

**チェックポイント:**
- [ ] 削除ボタンが表示される（編集者権限の場合）
- [ ] 確認ダイアログが表示される
- [ ] 「削除」をクリックするとファイルが削除される
- [ ] 削除後、ファイルが一覧から消える
- [ ] 成功メッセージが表示される
- [ ] ページリロード後も削除が維持される

**期待される動作:**
- ファイルが正常に削除される
- 削除後、一覧から消える
- データベースからも削除される

##### 4. フォルダ削除（編集者権限のみ）

**手順:**
1. 空のフォルダの削除ボタンをクリック
2. 確認ダイアログが表示されることを確認
3. 「削除」を選択
4. フォルダが一覧から削除されることを確認
5. ファイルが含まれるフォルダの削除を試みる
6. 警告メッセージが表示されることを確認

**チェックポイント:**
- [ ] 削除ボタンが表示される（編集者権限の場合）
- [ ] 確認ダイアログが表示される
- [ ] 空のフォルダは削除できる
- [ ] ファイルが含まれるフォルダは削除できない（または警告が表示される）
- [ ] 削除後、フォルダが一覧から消える
- [ ] 成功メッセージが表示される

**期待される動作:**
- 空のフォルダは正常に削除される
- ファイルが含まれるフォルダは削除できない（または警告が表示される）
- 削除後、一覧から消える

#### チェックリスト（全体）

- [ ] 既存ファイルのダウンロードが動作する
- [ ] ダウンロードしたファイルの内容が正しい
- [ ] フォルダの開閉が動作する
- [ ] パンくずナビゲーションが正しく更新される
- [ ] ファイル削除が動作する（編集者権限）
- [ ] フォルダ削除が動作する（編集者権限）
- [ ] 削除後、一覧から消える
- [ ] 削除が永続化される

---

### 8.3 メタデータの確認

#### 目的
既存ドキュメントのメタデータ（アップロード日時、アップロード者、ファイルサイズ）が正しく表示されることを確認する。

#### テスト手順

##### 1. ファイルメタデータの確認

**手順:**
1. ファイル一覧を表示
2. 各ファイルのメタデータを確認
3. ファイルの詳細情報（プロパティ）を開く
4. すべてのメタデータが正しく表示されることを確認

**確認項目:**

| メタデータ項目 | 確認内容 | チェック |
|--------------|---------|---------|
| ファイル名 | 元のファイル名が表示される | [ ] |
| ファイルサイズ | 正しいサイズが表示される（KB、MB単位） | [ ] |
| ファイルタイプ | 正しい拡張子が表示される | [ ] |
| アップロード日時 | 正しい日時が表示される（YYYY年MM月DD日 HH:MM形式） | [ ] |
| アップロード者 | 正しいユーザー名が表示される | [ ] |
| 最終更新日時 | 正しい日時が表示される | [ ] |
| フォルダパス | 正しいフォルダパスが表示される | [ ] |

##### 2. フォルダメタデータの確認

**手順:**
1. フォルダ一覧を表示
2. 各フォルダのメタデータを確認
3. フォルダの詳細情報を開く
4. すべてのメタデータが正しく表示されることを確認

**確認項目:**

| メタデータ項目 | 確認内容 | チェック |
|--------------|---------|---------|
| フォルダ名 | 正しいフォルダ名が表示される | [ ] |
| 作成日時 | 正しい日時が表示される | [ ] |
| 作成者 | 正しいユーザー名が表示される | [ ] |
| ファイル数 | フォルダ内のファイル数が正しい | [ ] |
| サブフォルダ数 | サブフォルダ数が正しい | [ ] |
| 合計サイズ | フォルダ内の合計サイズが正しい | [ ] |

##### 3. 統計情報の確認

**手順:**
1. ドキュメント管理セクションのヘッダーまたはフッターを確認
2. 統計情報が表示されることを確認
3. 数値が正しいことを確認

**確認項目:**

| 統計項目 | 確認内容 | チェック |
|---------|---------|---------|
| 総ファイル数 | カテゴリ内の全ファイル数が正しい | [ ] |
| 総フォルダ数 | カテゴリ内の全フォルダ数が正しい | [ ] |
| 合計サイズ | カテゴリ内の合計サイズが正しい | [ ] |
| 最近のファイル | 最近アップロードされたファイルが表示される | [ ] |

#### チェックリスト

- [ ] ファイル名が正しく表示される
- [ ] ファイルサイズが正しく表示される（適切な単位で）
- [ ] ファイルタイプ（拡張子）が正しく表示される
- [ ] アップロード日時が正しく表示される
- [ ] アップロード者名が正しく表示される
- [ ] フォルダ作成日時が正しく表示される
- [ ] フォルダ作成者名が正しく表示される
- [ ] フォルダ内のファイル数が正しい
- [ ] フォルダ内のサブフォルダ数が正しい
- [ ] フォルダの合計サイズが正しい
- [ ] カテゴリ全体の統計情報が正しい

#### 期待される結果
- すべてのメタデータが正しく表示される
- 日時フォーマットが統一されている
- ファイルサイズが適切な単位で表示される
- ユーザー名が正しく表示される

---

## テスト実行記録

### テスト環境情報

| 項目 | 内容 |
|-----|------|
| テスト日時 | YYYY-MM-DD HH:MM |
| テスト実施者 | [名前] |
| ブラウザ | [ブラウザ名とバージョン] |
| OS | [OS名とバージョン] |
| 施設ID | [テスト対象の施設ID] |
| 施設名 | [テスト対象の施設名] |

### テスト結果サマリー

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| 8.1 既存ドキュメントの表示確認 | ✅ / ❌ | |
| 8.2 既存ドキュメントの操作確認 | ✅ / ❌ | |
| 8.3 メタデータの確認 | ✅ / ❌ | |

### 発見された問題

#### 問題 #1
- **重要度**: 高 / 中 / 低
- **カテゴリ**: 表示 / 操作 / メタデータ / その他
- **説明**: [問題の詳細]
- **再現手順**:
  1. [手順1]
  2. [手順2]
  3. [手順3]
- **期待される動作**: [期待される動作]
- **実際の動作**: [実際の動作]
- **スクリーンショット**: [あれば添付]
- **対応状況**: 未対応 / 対応中 / 対応済み

#### 問題 #2
（必要に応じて追加）

---

## トラブルシューティング

### よくある問題と解決方法

#### 問題: ドキュメントが表示されない

**症状:**
- ドキュメントセクションを展開してもファイルやフォルダが表示されない
- 「ドキュメントがありません」というメッセージが表示される

**原因:**
1. カテゴリフィルタリングの問題
2. データベースのカテゴリ値が正しくない
3. ルートフォルダが作成されていない

**解決方法:**
1. ブラウザの開発者ツールでネットワークタブを確認
2. APIレスポンスを確認
3. データベースで`document_folders`と`document_files`テーブルの`category`カラムを確認
4. `category = 'contracts'`であることを確認

```sql
-- フォルダのカテゴリ確認
SELECT id, facility_id, name, category, parent_id 
FROM document_folders 
WHERE facility_id = [施設ID] AND category = 'contracts';

-- ファイルのカテゴリ確認
SELECT id, facility_id, original_name, category, folder_id 
FROM document_files 
WHERE facility_id = [施設ID] AND category = 'contracts';
```

#### 問題: ファイルダウンロードが失敗する

**症状:**
- ダウンロードボタンをクリックしても何も起こらない
- 404エラーが表示される
- ファイルが破損している

**原因:**
1. ファイルパスが正しくない
2. ストレージにファイルが存在しない
3. 権限の問題

**解決方法:**
1. ブラウザの開発者ツールでコンソールエラーを確認
2. ネットワークタブでAPIレスポンスを確認
3. サーバーログを確認
4. ストレージディレクトリを確認

```bash
# ストレージディレクトリの確認
ls -la storage/app/public/documents/

# ファイルの存在確認
find storage/app/public/documents/ -name "*.pdf"
```

#### 問題: フォルダ階層が正しく表示されない

**症状:**
- フォルダ階層が平坦に表示される
- サブフォルダが表示されない
- パンくずナビゲーションが正しくない

**原因:**
1. `parent_id`の関連付けが正しくない
2. `path`カラムが正しくない
3. JavaScriptのフォルダ階層処理に問題がある

**解決方法:**
1. データベースで`parent_id`と`path`を確認
2. ブラウザの開発者ツールでAPIレスポンスを確認
3. JavaScriptコンソールでエラーを確認

```sql
-- フォルダ階層の確認
SELECT id, name, parent_id, path, category 
FROM document_folders 
WHERE facility_id = [施設ID] AND category = 'contracts'
ORDER BY path;
```

#### 問題: メタデータが表示されない

**症状:**
- アップロード日時が表示されない
- アップロード者が「不明」と表示される
- ファイルサイズが表示されない

**原因:**
1. データベースのカラムが空
2. リレーションシップの問題
3. フォーマット処理の問題

**解決方法:**
1. データベースでメタデータを確認
2. `with()`でリレーションシップが正しくロードされているか確認
3. ブラウザの開発者ツールでAPIレスポンスを確認

```sql
-- ファイルメタデータの確認
SELECT 
    df.id, 
    df.original_name, 
    df.file_size, 
    df.created_at, 
    df.uploaded_by,
    u.name as uploader_name
FROM document_files df
LEFT JOIN users u ON df.uploaded_by = u.id
WHERE df.facility_id = [施設ID] AND df.category = 'contracts';
```

---

## 補足情報

### データベーススキーマ

#### document_folders テーブル
```sql
CREATE TABLE document_folders (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    facility_id BIGINT UNSIGNED NOT NULL,
    parent_id BIGINT UNSIGNED NULL,
    category VARCHAR(50) NOT NULL,
    name VARCHAR(255) NOT NULL,
    path TEXT NOT NULL,
    created_by BIGINT UNSIGNED NOT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    FOREIGN KEY (facility_id) REFERENCES facilities(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES document_folders(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_facility_category (facility_id, category),
    INDEX idx_parent (parent_id)
);
```

#### document_files テーブル
```sql
CREATE TABLE document_files (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    facility_id BIGINT UNSIGNED NOT NULL,
    folder_id BIGINT UNSIGNED NOT NULL,
    category VARCHAR(50) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    stored_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    file_size BIGINT UNSIGNED NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_extension VARCHAR(20) NOT NULL,
    uploaded_by BIGINT UNSIGNED NOT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    FOREIGN KEY (facility_id) REFERENCES facilities(id) ON DELETE CASCADE,
    FOREIGN KEY (folder_id) REFERENCES document_folders(id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES users(id),
    INDEX idx_facility_category (facility_id, category),
    INDEX idx_folder (folder_id)
);
```

### APIエンドポイント

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/facilities/{facility}/contract-documents` | ドキュメント一覧取得 |
| POST | `/facilities/{facility}/contract-documents/upload` | ファイルアップロード |
| POST | `/facilities/{facility}/contract-documents/folders` | フォルダ作成 |
| GET | `/facilities/{facility}/contract-documents/files/{file}/download` | ファイルダウンロード |
| DELETE | `/facilities/{facility}/contract-documents/files/{file}` | ファイル削除 |
| DELETE | `/facilities/{facility}/contract-documents/folders/{folder}` | フォルダ削除 |
| PUT | `/facilities/{facility}/contract-documents/files/{file}/rename` | ファイル名変更 |
| PUT | `/facilities/{facility}/contract-documents/folders/{folder}/rename` | フォルダ名変更 |

### カテゴリ値

契約書ドキュメントのカテゴリ値は `'contracts'` です。

```php
// ContractDocumentService.php
const CATEGORY = 'contracts';
const CATEGORY_NAME = '契約書';
```

---

## テスト完了基準

すべてのテスト項目が以下の基準を満たすこと:

1. **表示確認**
   - すべての既存フォルダが表示される
   - すべての既存ファイルが表示される
   - フォルダ階層が正しく維持されている

2. **操作確認**
   - ファイルダウンロードが正常に動作する
   - フォルダの開閉が正常に動作する
   - ファイル削除が正常に動作する（編集者権限）
   - フォルダ削除が正常に動作する（編集者権限）

3. **メタデータ確認**
   - アップロード日時が正しく表示される
   - アップロード者が正しく表示される
   - ファイルサイズが正しく表示される
   - すべてのメタデータが正確である

4. **エラーがないこと**
   - JavaScriptエラーが発生しない
   - APIエラーが発生しない
   - データベースエラーが発生しない

---

## 次のステップ

テストが完了したら:

1. テスト結果を記録する
2. 発見された問題を報告する
3. 必要に応じて修正を実施する
4. 再テストを実施する
5. すべてのテストが合格したら、タスク8を完了とする

---

## 参考資料

- [契約書ドキュメント統合 - 要件定義](.kiro/specs/contract-document-consolidation/requirements.md)
- [契約書ドキュメント統合 - 設計書](.kiro/specs/contract-document-consolidation/design.md)
- [契約書ドキュメント統合 - 実装タスク](.kiro/specs/contract-document-consolidation/tasks.md)
- [ドキュメント管理システム実装ガイド](docs/document-management/README.md)
