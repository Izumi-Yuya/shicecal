# 防災・防犯タブ ドキュメント管理機能

## 概要

防災・防犯タブの各サブタブ（防犯カメラ・電子錠、消防・防災）にライフライン設備と同様のドキュメント管理機能を追加しました。

## 主な機能

- **フォルダ管理**: フォルダの作成、名前変更、削除
- **ファイル管理**: ファイルのアップロード、ダウンロード、名前変更、移動、削除
- **表示モード**: リスト表示とグリッド表示の切り替え
- **検索・フィルター**: ファイル名検索、ファイルタイプフィルター
- **ソート**: 名前、日付、サイズでソート
- **権限管理**: ロールベースのアクセス制御

## クイックスタート

### ユーザー向け

1. 施設詳細画面を開く
2. 「防犯・防災」タブをクリック
3. 「防犯カメラ・電子錠」または「消防・防災」サブタブを選択
4. 「ドキュメント」ボタンをクリック
5. ドキュメント管理モーダルで操作を実行

### 開発者向け

実装の詳細は以下のドキュメントを参照してください：

- [実装ガイド](./document-management-implementation.md) - 技術的な実装の詳細
- [実装チェックリスト](./implementation-checklist.md) - テスト項目と確認事項

## ファイル構成

```
resources/views/facilities/security-disaster/
└── index.blade.php                    # 防災・防犯タブのメインビュー（更新済み）

app/Services/
├── LifelineDocumentService.php        # ドキュメント管理サービス（既存）
└── DocumentService.php                # 汎用ドキュメントサービス（既存）

app/Http/Controllers/
└── LifelineDocumentController.php     # ドキュメント管理コントローラー（既存）

resources/views/components/
└── lifeline-document-manager.blade.php # ドキュメント管理コンポーネント（既存）

resources/js/modules/
└── LifelineDocumentManager.js         # ドキュメント管理JavaScript（既存）
```

## 変更内容

### 更新されたファイル

1. **resources/views/facilities/security-disaster/index.blade.php**
   - 各サブタブにドキュメント管理ボタンを追加
   - 2つのドキュメント管理モーダルを追加（防犯カメラ・電子錠用、消防・防災用）

### 既存のサポート機能

以下の機能は既に実装されており、追加の変更は不要です：

- LifelineDocumentService（`security_disaster`カテゴリをサポート）
- LifelineDocumentController（すべてのライフラインカテゴリをサポート）
- ルート設定（`lifeline-documents/{category}`）
- lifeline-document-managerコンポーネント
- LifelineDocumentManager.js

## 使用例

### フォルダ作成

```
1. ドキュメント管理モーダルを開く
2. 「新しいフォルダ」ボタンをクリック
3. フォルダ名を入力（例：「点検報告書」）
4. 「作成」ボタンをクリック
```

### ファイルアップロード

```
1. ドキュメント管理モーダルを開く
2. 「ファイルアップロード」ボタンをクリック
3. ファイルを選択（PDF、画像など）
4. 「アップロード」ボタンをクリック
```

### ファイルダウンロード

```
1. ドキュメント管理モーダルを開く
2. ファイル名をクリック
3. ファイルがダウンロードされる
```

## 推奨フォルダ構造

### 防犯カメラ・電子錠

```
防犯・防災設備/
├── 防犯カメラ/
│   ├── 配置図/
│   ├── 保守記録/
│   └── 取扱説明書/
└── 電子錠/
    ├── 配置図/
    ├── 保守記録/
    └── 取扱説明書/
```

### 消防・防災

```
防犯・防災設備/
├── 消防/
│   ├── 訓練報告書/
│   ├── 点検報告書/
│   └── 証明書類/
└── 防災/
    ├── ハザードマップ/
    ├── 避難経路図/
    ├── 訓練報告書/
    └── 備蓄品リスト/
```

## トラブルシューティング

### モーダルが開かない

**原因**: JavaScriptエラーまたはBootstrapの読み込み問題

**解決方法**:
1. ブラウザのコンソールでエラーを確認
2. ページをリロード
3. キャッシュをクリア

### ファイルアップロードが失敗する

**原因**: ファイルサイズ超過、権限不足、ストレージ問題

**解決方法**:
1. ファイルサイズが10MB以下か確認
2. 編集権限があるか確認
3. サーバーログを確認（`storage/logs/laravel.log`）

### ドキュメント一覧が表示されない

**原因**: APIエラー、権限不足、データベース問題

**解決方法**:
1. ネットワークタブでAPIレスポンスを確認
2. 施設へのアクセス権限があるか確認
3. サーバーログを確認

## セキュリティ

- すべてのドキュメント操作は認証が必要
- ポリシーベースの認可チェック（LifelineEquipmentPolicy）
- ファイルタイプとサイズのバリデーション
- アクティビティログによる操作の追跡

## 制限事項

1. **ファイルサイズ**: 最大10MB
2. **ファイルタイプ**: PDF、画像、Office文書など（設定による）
3. **同時アップロード**: 複数ファイルの同時アップロードは可能だが、大量のファイルは避ける
4. **ブラウザ互換性**: モダンブラウザ（Chrome、Firefox、Safari、Edge）

## 今後の改善予定

- [ ] ファイルプレビュー機能
- [ ] バージョン管理機能
- [ ] 一括ダウンロード機能
- [ ] ファイル共有機能
- [ ] ファイルタグ機能
- [ ] サブカテゴリ別のルートフォルダ分離

## サポート

問題が発生した場合は、以下の情報を含めて報告してください：

1. 発生した問題の詳細
2. 再現手順
3. ブラウザとバージョン
4. スクリーンショット（可能な場合）
5. ブラウザコンソールのエラーメッセージ
6. サーバーログのエラーメッセージ

## 関連ドキュメント

- [ライフライン設備ドキュメント管理ガイド](../lifeline-equipment/document-management-guide.md)
- [モーダル実装ガイドライン](../../.kiro/steering/modal-implementation-guide.md)
- [ファイル処理ガイドライン](../../.kiro/steering/file-handling.md)

## 変更履歴

### 2025-10-14
- 初回実装
- 防犯カメラ・電子錠タブにドキュメント管理機能を追加
- 消防・防災タブにドキュメント管理機能を追加
- ドキュメント作成
